%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \file       main.tex
% \brief      Главный файл настроек TeX проекта
% \date       24.08.22 - создан
% \author     Соболев А.А.
% \details    Для сборки в TexStudio - выбрать компилятор xelatex в настройках проекта
%             Для сборки при помощи CMake - mkdir build && cd build && cmake .. && make	
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[headings=chapterprefix,a5paper]{book}
\usepackage{tikz}
\usepackage{tocloft}
\usepackage{pgfornament}
\usepackage{amsmath}
\usepackage{gensymb} % Для знака градуса
\usepackage{cite}
\usepackage{pstricks}
\usepackage{psvectorian}
\usepackage{fontspec}
\usepackage[russian]{babel}
\usepackage{afterpage}
\usepackage{graphicx}
\graphicspath{ {./pictures/} }
%\usepackage{courier}
\usepackage[pages=some]{background}

\newcommand\MyVarAuthorName{А.А.~Соболев}
\newcommand\MyVarBookName{Вепсская летопись}
%\newcommand\MyVarAuthorName{Автор}
%\newcommand\MyVarBookName{Название}

\setmainfont[%
ItalicFont=NewCM10-Italic.otf,%
BoldFont=NewCM10-Bold.otf,%
BoldItalicFont=NewCM10-BoldItalic.otf,%
SmallCapsFeatures={Numbers=OldStyle}]{NewCM10-Regular.otf}

\setsansfont[%
ItalicFont=NewCMSans10-Oblique.otf,%
BoldFont=NewCMSans10-Bold.otf,%
BoldItalicFont=NewCMSans10-BoldOblique.otf,%
SmallCapsFeatures={Numbers=OldStyle}]{NewCMSans10-Regular.otf}

%\setmonofont[ItalicFont=NewCMMono10-Italic.otf,%
\newfontfamily{\monofont}[ItalicFont=NewCMMono10-Italic.otf,%
BoldFont=NewCMMono10-Bold.otf,%
BoldItalicFont=NewCMMono10-BoldOblique.otf,%
SmallCapsFeatures={Numbers=OldStyle}]{NewCMMono10-Regular.otf}

%--------------------------------------
% эпиграф
\usepackage{epigraph}
\setlength{\epigraphwidth}{0.65\textwidth}
\renewcommand{\textflush}{flushleft} \renewcommand{\sourceflush}{flushleft}
\let\originalepigraph\epigraph 
\renewcommand\epigraph[2]{\originalepigraph{\textit{#1}}{\scriptsize{#2}}} %\textsc
%------------------------------------------------------------------------------------------------------------
%настройки для А4
%\usepackage[12pt]{extsizes}
%\usepackage[left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm]{geometry}
%\linespread{1.15} % по умолчанию 1.0
%------------------------------------------------------------------------------------------------------------
%настройки для А5
\usepackage[11pt]{extsizes}
\usepackage[left=1.5cm,right=1.5cm,top=2.0cm,bottom=2.0cm]{geometry}
\linespread{1.0} % по умолчанию 1.0
%------------------------------------------------------------------------------------------------------------
%настройки для А4
%\newcommand{\corner}[1]{%
%	\begin{tikzpicture}[remember picture, overlay]
%	\node[anchor=north east, shift={(-2.5cm,-5.3cm)}] at (current page.north east){%
%		\pgfornament[width=2.2cm]{#1}};
%	\end{tikzpicture}%
%}
%------------------------------------------------------------------------------------------------------------
%настройки для А5
\newcommand{\corner}[1]{%
	\begin{tikzpicture}[remember picture, overlay]
	\node[anchor=north east, shift={(-1.5cm,-4.2cm)}] at (current page.north east){%
		\pgfornament[width=2.2cm]{#1}};
	\end{tikzpicture}%
}
%------------------------------------------------------------------------------------------------------------
\usetikzlibrary{celtic}
\newcommand{\uzor}{%	
\begin{center}
	\begin{tikzpicture}[%
	scale=0.17,
	transform shape,
	celtic path/.style={
		draw,
		black!10!red,
%		double distance=0.6mm,
%		line width=0.375mm
		double=white,%black!10!red, 
		double distance=0.6mm,
		line width=0.3mm
	}
	]
	\CelticDrawPath{
		size={64,4},
		max steps=64
	}
	\end{tikzpicture}	
\end{center}
}

\newcommand{\greenline}{
\begin{center}
	\begin{tikzpicture}
		\fill[fill=black!30!green,] (0,0) rectangle (10.8,0.2);
	\end{tikzpicture}
\end{center}
}
%---------------------------------------------------------------------
\usepackage{indentfirst} % Первая строка главы - с красной строки
\setlength{\parindent}{1.0cm} % Отступ слева первой абзаца
\setlength{\parskip}{0.25cm} % Отступ между абзацами

% Заголовки сверху и снизу каждой страницы (Headers & footers)
\usepackage{fancyhdr}
\pagestyle{fancyplain}

% Сделаем печать названия Части на левой странице
\newcommand*\parttitle{}
\let\origpart\part
\renewcommand*{\part}[2][]{%
	\ifx\\#1\\% optional argument not present?
	\origpart{#2}%
	\renewcommand*\parttitle{Часть \thepart.\ #2}%
	\else
	\origpart[#1]{#2}%
	\renewcommand*\parttitle{#1}%
	\fi
}

\fancyhead[LE]{\fancyplain{}{\bfseries \parttitle}}
\fancyhead[CE]{\fancyplain{}{}}
\fancyhead[RE]{\fancyplain{}{}}

\fancyhead[LO]{\fancyplain{}{}}
\fancyhead[CO]{\fancyplain{}{}}
\fancyhead[RO]{\fancyplain{}{\bfseries \rightmark}}

\fancyfoot[LE]{\fancyplain{}{\bfseries \thepage}}
\fancyfoot[CE]{\fancyplain{}{}}
\fancyfoot[RE]{\fancyplain{}{\bfseries\scriptsize \MyVarBookName}}

\fancyfoot[LO]{\fancyplain{}{\bfseries\scriptsize \MyVarAuthorName }}
\fancyfoot[CO]{\fancyplain{}{}}
\fancyfoot[RO]{\fancyplain{}{\bfseries \thepage}}

\renewcommand{\footrulewidth}{0.4pt}
%\renewcommand{\chaptermark}[1]{\markright{Часть \thepart.\ \chaptername\ \thechapter.\ #1}{}}
\renewcommand{\chaptermark}[1]{\markright{\chaptername\ \thechapter.\ #1}{}}

% Пустая страница
\newcommand\blankpage{%
	\null%
	\thispagestyle{empty}%
	\newpage%
}%

\newcommand{\sdash}{\nobreakdash-}  % Дефис неразрывный без пробелов до и после
\newcommand{\ndash}{\nobreakdash~--~}  % Короткое тире неразрывное с пробелами до и после
\newcommand{\mdash}{\nobreakdash~---~} % Длинное тире неразрывное с пробелами до и после

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{tocloft,calc}
%\usepackage[newparttoc]{titlesec}
%\usepackage{titletoc}
%\usepackage{lipsum}
%\usepackage{tocbasic}
%
%\titleformat{\part}[display]
%{\centering\Huge\bfseries}{\partname~\thepart}
%{1em}{\normalfont\bfseries}
%
%\titlecontents{part}[3pc]{\addvspace{3pc}\filcenter}
%{\bfseries\partname~\thecontentslabel\\*[.2pc]\large}
%{\bfseries\large}{}[\addvspace{1pc}]
%
%%\renewcommand\cftchapdotsep{\cftdotsep}
%\titlecontents{chapter}[0em]{}
%{\bfseries\chaptername~\thecontentslabel\hspace{2em}}
%{\bfseries}
%{\mdseries\titlerule*[0.75em]{.}\bfseries\contentspage}

%\renewcommand{\cftpartfont}{\hfill\Large\bfseries\centering}
\usepackage{xpatch}
\makeatletter
\patchcmd{\l@part}{#1}{{\underline{Часть #1}}\vspace{1.5em}}{}{}
\makeatother
\addtocontents{toc}{\cftpagenumbersoff{part}}

%\renewcommand{\cftpartpresnum}{\Large Часть }
%\setlength{\cftbeforepartskip}{2.5em}
%\AtBeginDocument{\addtolength\cftpartnumwidth{\widthof{\bfseries Часть }}}

\renewcommand{\cftchappresnum}{ ~~Глава }
\setlength{\cftbeforechapskip}{0.7em}
%\renewcommand\cftchapafterpnum{\vskip 0em} % for spacing after each entry
\AtBeginDocument{\addtolength\cftchapnumwidth{\widthof{\bfseries ~~Глава~~ }}}

\renewcommand\cftchapdotsep{\cftdotsep} % Добавление точечек к элементу chapter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Фон
\backgroundsetup{
	scale=0.75,
	color=black,
	opacity=0.5,
	angle=-1,
	contents={%
%		\includegraphics[width=\paperwidth,height=\paperheight]{len}
		\includegraphics{len}
	}%
}

\begin{document}

\relpenalty=10000
\binoppenalty=10000
\clubpenalty=10000  % Это костыль против
\widowpenalty=10000 % "висячих" строк
\righthyphenmin=200 % Избавляемся
{\sloppy	        % от переносов слов
\input{titlepage}   % Обложка
\afterpage{\blankpage}
\input{annotation} % Аннотация глобально к сборнику
\afterpage{\blankpage}
\tableofcontents
\afterpage{\blankpage}
%
% ЧАСТЬ 1 - ЛИДЬ 2015
%
\input{лидь2015/часть1}
\input{лидь2015/аннотация}
\afterpage{\blankpage}
\input{лидь2015/введение}
\afterpage{\blankpage}
\input{лидь2015/несколько_слов_о_сплавах} 
\input{лидь2015/байдарка} 
\input{лидь2015/маршрут_и_сборы} 
\input{лидь2015/отъезд}
\input{лидь2015/заброска}
\input{лидь2015/катастрофа}
\input{лидь2015/фонтан}
\input{лидь2015/первая_дневка}
\input{лидь2015/дозаправка_в_чагоде}
\input{лидь2015/долгий_переход}
\input{лидь2015/кабаны_и_удача}
\input{лидь2015/вторая_дневка}
\input{лидь2015/досрочный_антистапель}
\input{лидь2015/возвращение}
\input{лидь2015/заключение}
%
% ЧАСТЬ 2 - ГОРЮН 2016
%
%\afterpage{\blankpage}
%\input{горюн2016/часть2}
%\input{горюн2016/аннотация}
%\afterpage{\blankpage}
%\input{горюн2016/введение}
%\afterpage{\blankpage}
%\input{горюн2016/снова_на_реку} 
%\input{горюн2016/команда} 
%\input{горюн2016/приготовления} 
%\input{горюн2016/заброска_микроавтобусом} 
%\input{горюн2016/стапель} 
%\input{горюн2016/проходим_устье_лиди} 
%\input{горюн2016/в_чагоде_год_спустя} 
%\input{горюн2016/в_ожидании_дневки} 
%\input{горюн2016/пятый_дневной_переход}
%\input{горюн2016/поиски_дневки}
%\input{горюн2016/урочище_лукобор}
%\input{горюн2016/целый_день_дождь}
%\input{горюн2016/выброска}
%\input{горюн2016/заключение}
%
% ЧАСТЬ 3 - ЛИДЬ 2017
%
%\input{лидь2017/часть3}
%\input{лидь2017/аннотация}
%\afterpage{\blankpage}
%\input{лидь2017/введение}
%\afterpage{\blankpage}
%\input{лидь2017/а_не_пошло_бы_все}
%\input{лидь2017/авантюра}
%\input{лидь2017/автозаброска}
%\input{лидь2017/радогощь}
%\input{лидь2017/гэс}
%\input{лидь2017/село_лидь}
%\input{лидь2017/дозаправка}
%\input{лидь2017/забелье}
%\input{лидь2017/третий_раз}
%\input{лидь2017/тургощь}
%
\bibliographystyle{apalike}%{plain}%{alpha}%
\bibliography{bibliography}
}
\end{document}
